<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuestionario SCAS-Child</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#e0f2ff; --bg2:#90caf9;
      --ink:#0f172a; --muted:#475569;
      --brand:#1e88e5; --brand-dark:#1565c0;
      --line:#e5e7eb; --radius:22px;
      --qhead-bg:#f6faff; --qhead-border:#e7eef8;
    }

    html, body { min-height: 100%; }
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
      min-height: 100vh;
      background:linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 100%);
      background-repeat:no-repeat;
    }

    .wrap{min-height:100%; display:grid; place-items:center; padding:32px 12px;}

    .card-quiz{
      width:100%;
      max-width:900px;
      background: transparent;
      border: none;
      box-shadow: none;
      padding:clamp(20px,4vw,40px);
    }

    .top-progress{margin-bottom:12px;}
    .progress{height:10px; background:#e6f0fb; border-radius:20px; overflow:hidden;}
    .progress-bar{background:var(--brand);}
    .step-indicator{color:var(--muted); font-weight:600; font-size:14px; text-align:right;}

    /* --- Helper banner (franja informativa arriba de la pregunta) --- */
    .helper-banner{
      display:flex; align-items:flex-start; gap:10px;
      background:#eaf4ff; border:1px solid #d6e9ff; color:#445b72;
      border-radius:12px; padding:10px 12px; margin:12px 0 14px;
      font-size:.95rem;
    }
    .helper-icon{
      flex:0 0 auto; width:18px; height:18px; margin-top:2px;
      color:var(--brand);
    }

    .qhead{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      background:var(--qhead-bg); border:1px solid var(--qhead-border);
      border-radius:16px; padding:16px 18px; margin:0 0 14px;
    }
    .qhead-text{
      font-size: clamp(16px, 2.2vw, 20px);
      font-weight: 700;
      line-height: 1.5;
      color: var(--ink);
    }

    .choices{display:grid; gap:12px; margin-top:8px;}
    .choice{
      position:relative; display:flex; align-items:center; gap:12px; border:1.5px solid #e5e7eb;
      border-radius:14px; padding:14px 16px; background:#fff; cursor:pointer;
      transition: border-color .18s ease, box-shadow .18s ease, background .18s ease, transform .04s ease;
    }
    .choice:hover{border-color:#cbd5e1; background:#fbfdff;}
    .choice:active{transform:scale(.997);}
    .letter{
      width:28px; height:28px; border-radius:7px; display:grid; place-items:center; font-weight:700; font-size:13px;
      border:1px solid #e2e8f0; color:#334155; background:#f8fafc;
    }
    .ctext{flex:1; color:#0f172a; font-weight:600}
    .mark{
      width:22px; height:22px; border-radius:50%; border:2px solid #cbd5e1; display:grid; place-items:center;
      font-size:14px; color:#fff; background:#fff;
    }
    .choices input{position:absolute; opacity:0; pointer-events:none;}
    .choices input:checked + label.choice{
      border-color: var(--brand); box-shadow:0 0 0 4px rgba(30,136,229,.12);
      background:#ffffff;
    }
    .choices input:checked + label .letter{
      border-color:#bfdbfe; background:#eaf2ff; color:#1e3a8a;
    }
    .choices input:checked + label .mark{
      background: var(--brand); border-color: var(--brand);
    }
    .choices input:checked + label .mark::before{
      content:"✓"; line-height:1; font-weight:800; font-size:12px;
    }

    .age-wrap{
      display:flex; 
      align-items:center; 
      gap:12px; 
      border:1.5px solid #e5e7eb; 
      background:#fff;
      border-radius:14px; 
      padding:14px 16px; 
      width:100%;          /* ocupa todo el ancho disponible */
      max-width:100%;      /* elimina el límite de 420px */
      box-sizing:border-box; /* asegura que padding/borde no se salgan */
    }
    .age-wrap input{
      height:46px; 
      border-radius:10px; 
      border:1px solid #e5e7eb; 
      padding:0 14px; 
      width:140px; 
      font-weight:600;
    }

    .navs{display:flex; justify-content:space-between; gap:12px; margin-top:22px}
    .btn{border-radius:999px; font-weight:600; padding:.65rem 1.2rem;}
    .btn-prev{background:#eef2f7; border-color:#eef2f7; color:#0f172a;}
    .btn-prev:hover{background:#e2e8f0; border-color:#e2e8f0;}
    .btn-next, .btn-submit { background: #eef2f7; border-color: #eef2f7; color: #0f172a; }
    .btn-next:hover, .btn-submit:hover { background: #e2e8f0; border-color: #e2e8f0; }

    @media (max-width: 640px){
      .step-indicator{text-align:left;}
    }

    /* === Navbar compacto === */
    .navbar-brand{
      font-weight:800; letter-spacing:.2px; color:var(--ink);
      display:flex; align-items:center; gap:.6rem;
    }
    .brand-badge{
      width:28px; height:28px; border-radius:10px;
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
      display:grid; place-items:center; color:#fff; font-weight:700; font-size:.9rem;
      box-shadow: 0 6px 18px rgba(21,101,192,.25);
    }
    .user-chip{
      display:flex; align-items:center; gap:.6rem;
      border:1px solid #e9eef5;
      border-radius:999px; padding:.35rem .6rem .35rem .35rem;
    }
    .avatar{
      width:28px; height:28px; border-radius:50%;
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
      color:#fff; font-weight:700; font-size:.85rem; display:grid; place-items:center;
    }
    .user-label{ color:#64748b; font-size:.75rem; line-height:1; }
    .user-name{ color:#0f172a; font-weight:600; line-height:1; }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-glass sticky-top">
    <div class="container-xxl">
      <a class="navbar-brand" href="/">
        <span class="brand-badge">S</span>
        <span>SCAS</span>
      </a>

      <div class="ms-auto">
        <div class="user-chip">
          <div class="avatar">{{ (usuario_nombre[0] if usuario_nombre else 'I')|upper }}</div>
          <div class="d-none d-sm-block">
            <div class="user-label">Bienvenido,</div>
            <div class="user-name">{{ usuario_nombre or 'Invitado' }}</div>
          </div>
          <div class="user-name d-sm-none">{{ usuario_nombre or 'Invitado' }}</div>
        </div>
      </div>
    </div>
  </nav>

  <main class="wrap">
    <form id="quizForm" action="/guardar" method="post" class="card-quiz">
      <!-- id de usuario desde Flask -->
      <input type="hidden" name="id_usuario" value="{{ uid }}">

      <div class="top-progress">
        <div class="progress" role="progressbar" aria-label="Progreso">
          <div id="pbar" class="progress-bar" style="width:0%"></div>
        </div>
        <div class="step-indicator mt-1" id="stepLabel">Paso 1 de 40</div>
      </div>

      <!-- Helper banner (se muestra solo en pasos de pregunta) -->
      <div id="freqBanner" class="helper-banner d-none">
        <svg class="helper-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <circle cx="12" cy="16" r="1.2"></circle>
        </svg>
        <div>
          <strong>Instrucciones:</strong>
          Por favor responde indicando con qué frecuencia has experimentado este problema
          las últimas 4 semanas (<em>incluyendo hoy</em>).
        </div>
      </div>

      <!-- Encabezado de la pregunta -->
      <div id="qHead" class="qhead">
        <div class="qhead-text" id="qHeadText"></div>
      </div>

      <div id="stepContainer"></div>

      <div class="navs">
        <button type="button" class="btn btn-prev" id="btnPrev">Anterior</button>
        <button type="button" class="btn btn-next" id="btnNext">Siguiente</button>
        <button type="submit" class="btn btn-submit d-none" id="btnSubmit">Obtener mis resultados</button>
      </div>

      <!-- aquí agregaremos hidden inputs (edad, genero, p1..p38) vía JS -->
      <div id="hiddenBox"></div>
    </form>
  </main>

  <script>
    const steps = [
      { type:'age',   text:'Ingresa tu edad' },
      { type:'gender',text:'¿Cuál es tu identidad de género?' },
      {type:'q', name:'p1',  text:'Hay cosas que me preocupan...'},
      {type:'q', name:'p2',  text:'Me da miedo la oscuridad...'},
      {type:'q', name:'p3',  text:'Cuando tengo un problema noto una sensación extraña en el estómago...'},
      {type:'q', name:'p4',  text:'Tengo miedo...'},
      {type:'q', name:'p5',  text:'Tendría miedo si me quedara solo en casa...'},
      {type:'q', name:'p6',  text:'Me da miedo hacer un examen...'},
      {type:'q', name:'p7',  text:'Me da miedo usar aseos públicos...'},
      {type:'q', name:'p8',  text:'Me preocupo cuando estoy lejos de mis padres...'},
      {type:'q', name:'p9',  text:'Tengo miedo de hacer el ridículo delante de la gente...'},
      {type:'q', name:'p10', text:'Me preocupa hacer mal el trabajo de la escuela...'},
      {type:'q', name:'p11', text:'Me preocupa que algo malo le suceda a alguien de mi familia...'},
      {type:'q', name:'p12', text:'De repente siento que no puedo respirar sin motivo...'},
      {type:'q', name:'p13', text:'Necesito comprobar varias veces que he hecho bien las cosas...'},
      {type:'q', name:'p14', text:'Me da miedo dormir solo...'},
      {type:'q', name:'p15', text:'Estoy nervioso o tengo miedo por las mañanas antes de ir al colegio...'},
      {type:'q', name:'p16', text:'Me dan miedo los perros...'},
      {type:'q', name:'p17', text:'No puedo dejar de pensar en cosas malas o tontas...'},
      {type:'q', name:'p18', text:'Cuando tengo un problema mi corazón late muy fuerte...'},
      {type:'q', name:'p19', text:'De repente empiezo a temblar sin motivo...'},
      {type:'q', name:'p20', text:'Me preocupa que algo malo pueda pasarme...'},
      {type:'q', name:'p21', text:'Me da miedo ir al médico o al dentista...'},
      {type:'q', name:'p22', text:'Cuando tengo un problema me siento nervioso...'},
      {type:'q', name:'p23', text:'Me dan miedo los lugares altos o los ascensores...'},
      {type:'q', name:'p24', text:'Tengo que pensar en cosas especiales para evitar que pase algo malo...'},
      {type:'q', name:'p25', text:'Me da miedo viajar en coche, autobús o tren...'},
      {type:'q', name:'p26', text:'Me preocupa lo que otras personas piensan de mí...'},
      {type:'q', name:'p27', text:'Me da miedo estar en lugares donde hay mucha gente...'},
      {type:'q', name:'p28', text:'De repente tengo mucho miedo sin motivo...'},
      {type:'q', name:'p29', text:'Me dan miedo los insectos o las arañas...'},
      {type:'q', name:'p30', text:'De repente me siento mareado o creo que me voy a desmayar sin motivo...'},
      {type:'q', name:'p31', text:'Me da miedo tener que hablar delante de mis compañeros de clase...'},
      {type:'q', name:'p32', text:'De repente mi corazón late muy rápido sin motivo...'},
      {type:'q', name:'p33', text:'Me preocupa tener miedo de repente sin que haya nada que temer...'},
      {type:'q', name:'p34', text:'Me da miedo estar en lugares pequeños y cerrados...'},
      {type:'q', name:'p35', text:'Tengo que hacer algunas cosas una y otra vez...'},
      {type:'q', name:'p36', text:'Me molestan pensamientos tontos o malos, o imágenes en mi mente...'},
      {type:'q', name:'p37', text:'Tengo que hacer algunas cosas de una forma determinada para evitar que pasen cosas malas'},
      {type:'q', name:'p38', text:'Me daría miedo pasar la noche fuera de casa...'},
    ];

    const optionScale = [
      {letter:'A', label:'Nunca', value:'0'},
      {letter:'B', label:'A veces', value:'1'},
      {letter:'C', label:'Muchas veces', value:'2'},
      {letter:'D', label:'Siempre', value:'3'},
    ];

    const totalSteps = steps.length;
    let step = 0;

    const form = document.getElementById('quizForm');
    const stepContainer = document.getElementById('stepContainer');
    const pbar = document.getElementById('pbar');
    const stepLabel = document.getElementById('stepLabel');
    const qHeadText = document.getElementById('qHeadText');
    const freqBanner = document.getElementById('freqBanner');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const btnSubmit = document.getElementById('btnSubmit');

    // === crear inputs ocultos para edad, genero y p1..p38 ===
    (function makeHidden(){
      const hiddenBox = document.getElementById('hiddenBox');
      hiddenBox.innerHTML =
        `<input type="hidden" id="edad_hidden" name="edad">
         <input type="hidden" id="genero_hidden" name="genero">` +
        Array.from({length:38}, (_,i)=>`<input type="hidden" id="p${i+1}_hidden" name="p${i+1}">`).join('');
    })();

    function render(){
      const pct = Math.round((step)/(totalSteps-1) * 100);
      pbar.style.width = pct + '%';
      stepLabel.textContent = `Paso ${step+1} de ${totalSteps}`;

      btnPrev.disabled = (step === 0);
      btnNext.classList.toggle('d-none', step === totalSteps-1);
      btnSubmit.classList.toggle('d-none', step !== totalSteps-1);

      const s = steps[step];
      qHeadText.textContent = s.text;

      // Mostrar / ocultar la franja informativa solo en preguntas
      freqBanner.classList.toggle('d-none', s.type !== 'q');

      if(s.type === 'age'){
        stepContainer.innerHTML = `
          <div class="age-wrap">
            <input id="edad" name="edad_tmp" type="number" min="12" max="16" placeholder="Ej. 12" required>
          </div>
        `;
      } else if(s.type === 'gender'){
        stepContainer.innerHTML = `
          <div class="choices">
            <input id="gen_F" type="radio" name="genero_tmp" value="Femenino" required>
            <label for="gen_F" class="choice">
              <span class="letter">A</span>
              <span class="ctext">Femenino</span>
              <span class="mark"></span>
            </label>

            <input id="gen_M" type="radio" name="genero_tmp" value="Masculino" required>
            <label for="gen_M" class="choice">
              <span class="letter">B</span>
              <span class="ctext">Masculino</span>
              <span class="mark"></span>
            </label>
          </div>
        `;
      } else {
        const group = s.name;
        let html = `<div class="choices">`;
        optionScale.forEach((op,i)=>{
          const id = `${group}_${i}`;
          html += `
            <input id="${id}" type="radio" name="${group}_tmp" value="${op.value}" required>
            <label for="${id}" class="choice">
              <span class="letter">${op.letter}</span>
              <span class="ctext">${op.label}</span>
              <span class="mark"></span>
            </label>
          `;
        });
        html += `</div>`;
        stepContainer.innerHTML = html;
      }

      // restaurar lo guardado en hidden para este paso
      restoreCurrentStepSelection();
    }

    function restoreCurrentStepSelection(){
      const s = steps[step];
      if(s.type === 'age'){
        const saved = document.getElementById('edad_hidden').value;
        const edad = document.getElementById('edad');
        if (saved && edad) edad.value = saved;
      } else if(s.type === 'gender'){
        const saved = document.getElementById('genero_hidden').value;
        if (saved){
          const r = form.querySelector(`input[name="genero_tmp"][value="${saved}"]`);
          if (r) r.checked = true;
        }
      } else if(s.type === 'q'){
        const saved = document.getElementById(`${s.name}_hidden`).value;
        if (saved !== ''){
          const r = form.querySelector(`input[name="${s.name}_tmp"][value="${saved}"]`);
          if (r) r.checked = true;
        }
      }
    }

    function saveCurrentStep(){
      const s = steps[step];
      if(s.type === 'age'){
        const edad = document.getElementById('edad');
        if (edad) document.getElementById('edad_hidden').value = edad.value || '';
      } else if(s.type === 'gender'){
        const g = form.querySelector('input[name="genero_tmp"]:checked');
        if (g) document.getElementById('genero_hidden').value = g.value;
      } else if(s.type === 'q'){
        const sel = form.querySelector(`input[name="${s.name}_tmp"]:checked`);
        if (sel) document.getElementById(`${s.name}_hidden`).value = sel.value;
      }
    }

    function canProceed(){
      const s = steps[step];
      if(s.type === 'age'){
        const edad = document.getElementById('edad');
        if(!edad) return false;
        const v = Number(edad.value);
        return Number.isFinite(v) && v >= 12 && v <= 16;
      }
      if(s.type === 'gender'){
        return !!form.querySelector('input[name="genero_tmp"]:checked');
      }
      if(s.type === 'q'){
        return !!form.querySelector(`input[name="${s.name}_tmp"]:checked`);
      }
      return true;
    }

    function goNext(){
      if(!canProceed()){
        const invalid = stepContainer.querySelector('input:invalid') || stepContainer.querySelector('input');
        if(invalid && invalid.reportValidity) invalid.reportValidity();
        return;
      }
      // guarda lo elegido en este paso
      saveCurrentStep();

      if(step < totalSteps-1){
        step++;
        render();
      }
    }

    function goPrev(){
      // guarda antes de retroceder
      saveCurrentStep();
      if(step>0){
        step--;
        render();
      }
    }

    document.getElementById('btnNext').addEventListener('click', goNext);
    document.getElementById('btnPrev').addEventListener('click', goPrev);

    // Auto-avanzar al elegir opción (género y preguntas)
    stepContainer.addEventListener('change', (e) => {
      const el = e.target;
      if (el.matches('input[type="radio"]')) {
        saveCurrentStep();
        setTimeout(() => { goNext(); }, 60);
      }
    });

    form.addEventListener('submit', (e)=>{
      if(!canProceed()){
        e.preventDefault();
        return;
      }
      saveCurrentStep();
    });

    // arranque PARA INICIAR
    render();
  </script>
</body>
</html>


