<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuestionario BDI-II</title>
   
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#e0f2ff; --bg2:#90caf9;
      --ink:#0f172a; --muted:#475569;
      --brand:#1e88e5; --brand-dark:#1565c0;
      --line:#e5e7eb; --radius:22px;
      --qhead-bg:#f6faff; --qhead-border:#e7eef8;
    }

    html, body { min-height: 100%; }
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
      min-height: 100vh;
      background:linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 100%);
      background-repeat:no-repeat;
    }

    .wrap{min-height:100%; display:grid; place-items:center; padding:32px 12px;}

    .card-quiz{
      width:100%;
      max-width:900px;
      background: transparent;
      border: none;
      box-shadow: none;
      padding:clamp(20px,4vw,40px);
    }

    .top-progress{margin-bottom:12px;}
    .progress{height:10px; background:#e6f0fb; border-radius:20px; overflow:hidden;}
    .progress-bar{background:var(--brand);}
    .step-indicator{color:var(--muted); font-weight:600; font-size:14px; text-align:right;}

    /* --- Helper banner --- */
    .helper-banner{
      display:flex; align-items:flex-start; gap:10px;
      background:#eaf4ff; border:1px solid #d6e9ff; color:#445b72;
      border-radius:12px; padding:10px 12px; margin:12px 0 14px;
      font-size:.95rem;
    }
    .helper-icon{
      flex:0 0 auto; width:18px; height:18px; margin-top:2px;
      color:var(--brand);
    }

    .qhead{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      background:var(--qhead-bg); border:1px solid var(--qhead-border);
      border-radius:16px; padding:16px 18px; margin:0 0 14px;
    }
    .qhead-text{
      font-size: clamp(16px, 2.2vw, 20px);
      font-weight: 700;
      line-height: 1.5;
      color: var(--ink);
    }

    .choices{display:grid; gap:12px; margin-top:8px;}
    .choice{
      position:relative; display:flex; align-items:center; gap:12px; border:1.5px solid #e5e7eb;
      border-radius:14px; padding:14px 16px; background:#fff; cursor:pointer;
      transition: border-color .18s ease, box-shadow .18s ease, background .18s ease, transform .04s ease;
    }
    .choice:hover{border-color:#cbd5e1; background:#fbfdff;}
    .choice:active{transform:scale(.997);}
    .letter{
      width:28px; height:28px; border-radius:7px; display:grid; place-items:center; font-weight:700; font-size:13px;
      border:1px solid #e2e8f0; color:#334155; background:#f8fafc;
    }
    .ctext{flex:1; color:#0f172a; font-weight:600}
    .mark{
      width:22px; height:22px; border-radius:50%; border:2px solid #cbd5e1; display:grid; place-items:center;
      font-size:14px; color:#fff; background:#fff;
    }
    .choices input{position:absolute; opacity:0; pointer-events:none;}
    .choices input:checked + label.choice{
      border-color: var(--brand); box-shadow:0 0 0 4px rgba(30,136,229,.12);
      background:#ffffff;
    }
    .choices input:checked + label .letter{
      border-color:#bfdbfe; background:#eaf2ff; color:#1e3a8a;
    }
    .choices input:checked + label .mark{
      background: var(--brand); border-color: var(--brand);
    }
    .choices input:checked + label .mark::before{
      content:"✓"; line-height:1; font-weight:800; font-size:12px;
    }

    .age-wrap{
      display:flex; align-items:center; gap:12px; border:1.5px solid #e5e7eb; background:#fff;
      border-radius:14px; padding:14px 16px; width:100%; max-width:100%; box-sizing:border-box;
    }
    .age-wrap input{
      height:46px; border-radius:10px; border:1px solid #e5e7eb; padding:0 14px; width:140px; font-weight:600;
    }

    .navs{display:flex; justify-content:space-between; gap:12px; margin-top:22px}
    .btn{border-radius:999px; font-weight:600; padding:.65rem 1.2rem;}
    .btn-prev{background:#eef2f7; border-color:#eef2f7; color:#0f172a;}
    .btn-prev:hover{background:#e2e8f0; border-color:#e2e8f0;}
    .btn-next, .btn-submit { background: #eef2f7; border-color: #eef2f7; color: #0f172a; }
    .btn-next:hover, .btn-submit:hover { background: #e2e8f0; border-color: #e2e8f0; }

    @media (max-width: 640px){
      .step-indicator{text-align:left;}
    }

    /* === Navbar compacto === */
    .navbar-brand{ font-weight:800; letter-spacing:.2px; color:var(--ink); display:flex; align-items:center; gap:.6rem; }
    .brand-badge{
      width:28px; height:28px; border-radius:10px;
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
      display:grid; place-items:center; color:#fff; font-weight:700; font-size:.9rem;
      box-shadow: 0 6px 18px rgba(21,101,192,.25);
    }
    .user-chip{ display:flex; align-items:center; gap:.6rem; border:1px solid #e9eef5; border-radius:999px; padding:.35rem .6rem .35rem .35rem; cursor:pointer; background:#fff; }
    .avatar{ width:28px; height:28px; border-radius:50%; background: linear-gradient(135deg, var(--brand), var(--brand-dark)); color:#fff; font-weight:700; font-size:.85rem; display:grid; place-items:center; }
    .user-label{ color:#64748b; font-size:.75rem; line-height:1; }
    .user-name{ color:#0f172a; font-weight:600; line-height:1; }

    .navbar .ms-auto{ position:relative; }
    .user-menu{
      position:absolute; right:0; top:calc(100% + 10px);
      width:280px; background:#fff; border:1px solid #e7eef5;
      border-radius:16px; padding:10px; z-index:30;
      box-shadow:0 12px 28px rgba(15,23,42,.12);
      transform-origin: top right; transform:scale(.98); opacity:0;
      pointer-events:none; transition:.15s ease;
    }
    .user-menu.open{ transform:scale(1); opacity:1; pointer-events:auto; }
    .user-menu::before{
      content:""; position:absolute; right:24px; top:-8px;
      width:12px; height:12px; background:#fff; border-left:1px solid #e7eef5; border-top:1px solid #e7eef5;
      transform:rotate(45deg);
    }
    .um-header{ display:flex; gap:10px; align-items:center; padding:6px 8px 10px 8px; border-bottom:1px solid #eef2f7; margin-bottom:8px; }
    .um-avatar{ width:36px; height:36px; border-radius:50%; display:grid; place-items:center;
      background:linear-gradient(135deg, var(--brand), var(--brand-dark)); color:#fff; font-weight:700; }
    .um-name{ font-weight:700; line-height:1.2; }
    .um-sub{ font-size:.85rem; color:#64748b; }
    .um-list{ display:grid; gap:4px; margin:0; padding:0; list-style:none; }
    .um-item{ display:flex; gap:10px; align-items:center; padding:10px 12px; border-radius:10px; color:#0f172a; text-decoration:none; font-weight:600; }
    .um-item:hover{ background:#f6f9ff; }
    .um-item svg{ width:18px; height:18px; color:#64748b; }
    .um-danger{ color:#b42318; }
    .um-danger:hover{ background:#fff1f0; }

    .navbar-glass{
      background:#ffffff; border-bottom:1px solid #e9eef5; box-shadow:0 8px 20px rgba(15,23,42,.06);
      position: sticky; top:0; z-index: 1020;
    }
    .navbar-glass .container-xxl{ padding-top:.5rem; padding-bottom:.5rem; }
    .navbar-glass .navbar-brand,
    .navbar-glass .navbar-brand:focus,
    .navbar-glass .navbar-brand:hover{ color: var(--ink); }
  </style>
</head>
<body>

  {# ===== Nombre completo para el menú (NO cambia tu chip) ===== #}
  {% set _nombre = usuario_nombre|default('', true) %}
  {% set _apellido = usuario_apellido|default('', true) %}
  {% set nombre_completo = (_nombre ~ ' ' ~ _apellido)|trim %}

  <!-- NAVBAR -->
  <nav class="navbar navbar-glass sticky-top">
    <div class="container-xxl">
      <div class="ms-auto">
        <div id="userChip" class="user-chip" tabindex="0" aria-haspopup="true" aria-expanded="false" aria-controls="userMenu">
          <div class="avatar">{{ (usuario_nombre[0] if usuario_nombre else 'I')|upper }}</div>
          <div class="d-none d-sm-block">
            <div class="user-label">Bienvenido,</div>
            <div class="user-name">{{ usuario_nombre or 'Invitado' }}</div>
          </div>
          <div class="user-name d-sm-none">{{ usuario_nombre or 'Invitado' }}</div>
        </div>

        <!-- Menú de usuario -->
        <div id="userMenu" class="user-menu" role="menu" hidden>
          <div class="um-header">
            <div class="um-avatar">
              {{ ((nombre_completo|default('', true))[:1] or (usuario_nombre|default('', true))[:1] or 'I')|upper }}
            </div>
            <div>
              <div class="um-name">
                {{ (nombre_completo|default('', true)) or (usuario_nombre|default('Invitado', true)) }}
              </div>
              <div class="um-sub">Cuenta</div>
            </div>
          </div>
          <ul class="um-list">
            <li><a class="um-item" href="/perfil?uid={{ uid }}" role="menuitem">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              Editar perfil
            </a></li>

            <li><a class="um-item um-danger" href="/" role="menuitem">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16 17 21 12 16 7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
              </svg>
              Cerrar sesión
            </a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>
  
  <main class="wrap">
    <form id="quizForm" action="/guardar" method="post" class="card-quiz">
      <!-- id de usuario desde Flask -->
      <input type="hidden" name="id_usuario" value="{{ uid }}">

      <div class="top-progress">
        <div class="progress" role="progressbar" aria-label="Progreso">
          <div id="pbar" class="progress-bar" style="width:0%"></div>
        </div>
        <div class="step-indicator mt-1" id="stepLabel">Paso 1</div>
      </div>

      <!-- Helper banner -->
        <div id="freqBanner" class="helper-banner d-none">
           <svg class="helper-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
             <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
             <circle cx="12" cy="16" r="1.2"></circle>
          </svg>
        <div>
    <strong>Instrucciones:</strong>
    Durante las <strong>últimas dos semanas</strong>, ¿con qué frecuencia te han molestado
    los siguientes síntomas? Para cada síntoma marca <strong>una sola opción.</strong>
  </div>
</div>

      <!-- Encabezado de la pregunta -->
      <div id="qHead" class="qhead">
        <div class="qhead-text" id="qHeadText"></div>
      </div>

      <div id="stepContainer"></div>

      <div class="navs">
        <button type="button" class="btn btn-prev" id="btnPrev">Anterior</button>
        <button type="button" class="btn btn-next" id="btnNext">Siguiente</button>
        <button type="submit" class="btn btn-submit d-none" id="btnSubmit">Obtener mis resultados</button>
      </div>

      <!-- Hidden inputs (edad, genero, p1..p38) -->
      <div id="hiddenBox"></div>
    </form>
  </main>

  <script>
    // ==== Ítems PHQ-A con opciones textuales ====
     const steps = [
    {type:'q', name:'p1', text:'¿Te sientes desanimado, deprimido, irritado o sin esperanza?'},
    {type:'q', name:'p2', text:'¿Tienes poco interés o encuentras poco placer en hacer las cosas?'},
    {type:'q', name:'p3', text:'¿Tienes problemas para dormir, mantenerte dormido o duermes demasiado?'},
    {type:'q', name:'p4', text:'¿Tienes falta de apetito, pérdida de peso o comes en exceso?'},
    {type:'q', name:'p5', text:'¿Te sientes cansado o con poca energía?'},
    {type:'q', name:'p6', text:'¿Sientes falta de amor propio, que eres un fracaso, o que te has decepcionado a ti mismo o a tu familia?'},
    {type:'q', name:'p7', text:'¿Tienes dificultad para concentrarte en las tareas escolares, leer o ver la televisión?'},
    {type:'q', name:'p8', text:'¿Te mueves o hablas tan lentamente que la gente a tu alrededor lo nota? O, por el contrario, ¿estás tan agitado o inquieto que te mueves mucho más de lo acostumbrado?'},
    {type:'q', name:'p9', text:'¿Tienes pensamientos de que sería mejor estar muerto o de que quieres hacerte daño?'}
  ];

    // Fallback (no se usa porque cada ítem trae sus opciones)
    const optionScale = [
    {letter:'A', label:'Nunca',                         value:'0'},
    {letter:'B', label:'Varios días',                   value:'1'},
    {letter:'C', label:'Más de la mitad de los días',   value:'2'},
    {letter:'D', label:'Casi todos los días',           value:'3'},
  ];

    const totalSteps = steps.length;
    let step = 0;

    const form = document.getElementById('quizForm');
    const stepContainer = document.getElementById('stepContainer');
    const pbar = document.getElementById('pbar');
    const stepLabel = document.getElementById('stepLabel');
    const qHeadText = document.getElementById('qHeadText');
    const freqBanner = document.getElementById('freqBanner');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const btnSubmit = document.getElementById('btnSubmit');

    // === crear inputs ocultos para edad, genero y p1..p38 (compatibilidad backend) ===
    (function makeHidden(){
      const hiddenBox = document.getElementById('hiddenBox');
      hiddenBox.innerHTML =
        `<input type="hidden" id="edad_hidden" name="edad">
         <input type="hidden" id="genero_hidden" name="genero">` +
        Array.from({length:38}, (_,i)=>`<input type="hidden" id="p${i+1}_hidden" name="p${i+1}">`).join('');
    })();

    function render(){
      const pct = Math.round((step)/(totalSteps-1) * 100);
      pbar.style.width = pct + '%';
      stepLabel.textContent = `Paso ${step+1} de ${totalSteps}`;

      btnPrev.disabled = (step === 0);
      btnNext.classList.toggle('d-none', step === totalSteps-1);
      btnSubmit.classList.toggle('d-none', step !== totalSteps-1);

      const s = steps[step];
      qHeadText.textContent = s.text;

      // Mostrar / ocultar la franja informativa solo en preguntas
      freqBanner.classList.toggle('d-none', s.type !== 'q');

      if(s.type === 'age'){
        stepContainer.innerHTML = `
          <div class="age-wrap">
            <input id="edad" name="edad_tmp" type="number" min="12" max="100" placeholder="Ej. 16" required>
          </div>
        `;
      } else if(s.type === 'gender'){
        stepContainer.innerHTML = `
          <div class="choices">
            <input id="gen_F" type="radio" name="genero_tmp" value="Femenino" required>
            <label for="gen_F" class="choice">
              <span class="letter">A</span>
              <span class="ctext">Femenino</span>
              <span class="mark"></span>
            </label>

            <input id="gen_M" type="radio" name="genero_tmp" value="Masculino" required>
            <label for="gen_M" class="choice">
              <span class="letter">B</span>
              <span class="ctext">Masculino</span>
              <span class="mark"></span>
            </label>

            <input id="gen_O" type="radio" name="genero_tmp" value="Otro/Prefiero no decir" required>
            <label for="gen_O" class="choice">
              <span class="letter">C</span>
              <span class="ctext">Otro / Prefiero no decir</span>
              <span class="mark"></span>
            </label>
          </div>
        `;
      } else {
        const group = s.name;
        const opts = s.options && s.options.length ? s.options : optionScale;
        let html = `<div class="choices">`;
        opts.forEach((op,i)=>{
          const id = `${group}_${i}`;
          html += `
            <input id="${id}" type="radio" name="${group}_tmp" value="${op.value}" required>
            <label for="${id}" class="choice">
              <span class="letter">${op.letter}</span>
              <span class="ctext">${op.label}</span>
              <span class="mark"></span>
            </label>
          `;
        });
        html += `</div>`;
        stepContainer.innerHTML = html;
      }

      // restaurar lo guardado en hidden para este paso
      restoreCurrentStepSelection();
    }

    function restoreCurrentStepSelection(){
      const s = steps[step];
      if(s.type === 'age'){
        const saved = document.getElementById('edad_hidden').value;
        const edad = document.getElementById('edad');
        if (saved && edad) edad.value = saved;
      } else if(s.type === 'gender'){
        const saved = document.getElementById('genero_hidden').value;
        if (saved){
          const r = form.querySelector(`input[name="genero_tmp"][value="${CSS.escape(saved)}"]`);
          if (r) r.checked = true;
        }
      } else if(s.type === 'q'){
        const saved = document.getElementById(`${s.name}_hidden`).value;
        if (saved !== ''){
          const r = form.querySelector(`input[name="${s.name}_tmp"][value="${CSS.escape(saved)}"]`);
          if (r) r.checked = true;
        }
      }
    }

    function saveCurrentStep(){
      const s = steps[step];
      if(s.type === 'age'){
        const edad = document.getElementById('edad');
        if (edad) document.getElementById('edad_hidden').value = edad.value || '';
      } else if(s.type === 'gender'){
        const g = form.querySelector('input[name="genero_tmp"]:checked');
        if (g) document.getElementById('genero_hidden').value = g.value;
      } else if(s.type === 'q'){
        const sel = form.querySelector(`input[name="${s.name}_tmp"]:checked`);
        if (sel) document.getElementById(`${s.name}_hidden`).value = sel.value;
      }
    }

    function canProceed(){
      const s = steps[step];
      if(s.type === 'age'){
        const edad = document.getElementById('edad');
        if(!edad) return false;
        const v = Number(edad.value);
        return Number.isFinite(v) && v >= 12 && v <= 100;
      }
      if(s.type === 'gender'){
        return !!form.querySelector('input[name="genero_tmp"]:checked');
      }
      if(s.type === 'q'){
        return !!form.querySelector(`input[name="${s.name}_tmp"]:checked`);
      }
      return true;
    }

    function goNext(){
      if(!canProceed()){
        const invalid = stepContainer.querySelector('input:invalid') || stepContainer.querySelector('input');
        if(invalid && invalid.reportValidity) invalid.reportValidity();
        return;
      }
      // guarda lo elegido en este paso
      saveCurrentStep();

      if(step < totalSteps-1){
        step++;
        render();
      }
    }

    function goPrev(){
      // guarda antes de retroceder
      saveCurrentStep();
      if(step>0){
        step--;
        render();
      }
    }

    document.getElementById('btnNext').addEventListener('click', goNext);
    document.getElementById('btnPrev').addEventListener('click', goPrev);

    // Auto-avanzar al elegir opción
    stepContainer.addEventListener('change', (e) => {
      const el = e.target;
      if (el.matches('input[type="radio"]')) {
        saveCurrentStep();
        setTimeout(() => { goNext(); }, 60);
      }
    });

    form.addEventListener('submit', (e)=>{
      if(!canProceed()){
        e.preventDefault();
        return;
      }
      saveCurrentStep();
    });

    // === Menú de usuario: abrir/cerrar (solo UI) ===
    const userChip  = document.getElementById('userChip');
    const userMenu  = document.getElementById('userMenu');

    function closeUserMenu(){
      userMenu.classList.remove('open');
      userMenu.hidden = true;
      userChip.setAttribute('aria-expanded','false');
    }
    function toggleUserMenu(){
      const willOpen = userMenu.hidden || !userMenu.classList.contains('open');
      if (willOpen){
        userMenu.hidden = false;
        requestAnimationFrame(()=> userMenu.classList.add('open'));
        userChip.setAttribute('aria-expanded','true');
      }else{
        closeUserMenu();
      }
    }
    userChip.addEventListener('click', (e)=>{
      e.stopPropagation();
      toggleUserMenu();
    });
    document.addEventListener('click', (e)=>{
      if (!userMenu.contains(e.target) && !userChip.contains(e.target)){
        closeUserMenu();
      }
    });
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape') closeUserMenu();
    });
    userMenu.addEventListener('click', (e)=>{
      const a = e.target.closest('a');
      if (a) closeUserMenu();
    });

    // arranque
    render();

    // === MEMORIA LOCAL: recuerda paso y respuestas (por usuario) ===
    (function(){
      const uid = document.querySelector('input[name="id_usuario"]')?.value || 'anon';
      const KEY = `bdi2:${uid}:progreso`; // namespace nuevo para no chocar con SCAS previos

      function persist(){
        // Asegura que el paso actual esté volcado a los hidden antes de guardar
        saveCurrentStep();

        const data = {
          step,
          edad: document.getElementById('edad_hidden')?.value ?? '',
          genero: document.getElementById('genero_hidden')?.value ?? '',
          answers: {}
        };
        // guardamos p1..p21 (Beck); p22..p38 quedan vacíos
        for (let i = 1; i <= 21; i++){
          const v = document.getElementById(`p${i}_hidden`)?.value;
          data.answers[`p${i}`] = (v ?? '');
        }
        try { localStorage.setItem(KEY, JSON.stringify(data)); } catch {}
      }

      function restore(){
        const raw = localStorage.getItem(KEY);
        if (!raw) return;
        try {
          const st = JSON.parse(raw);

          // Rellenar hidden con lo guardado
          if (st.edad != null)   document.getElementById('edad_hidden').value   = String(st.edad);
          if (st.genero != null) document.getElementById('genero_hidden').value = String(st.genero);
          if (st.answers){
            for (let i=1; i<=21; i++){
              const val = st.answers[`p${i}`];
              if (val != null) document.getElementById(`p${i}_hidden`).value = String(val);
            }
          }

          // Volver al paso donde se quedó
          if (Number.isInteger(st.step) && st.step >= 0 && st.step < steps.length){
            step = st.step;
          }
          render();
        } catch {}
      }

      function clearMem(){ localStorage.removeItem(KEY); }

      // Restaurar al entrar
      restore();

      // Guardar cuando cambian edad/género/preguntas
      document.addEventListener('change', (e)=>{
        const nm = e.target.name || '';
        if (nm === 'edad_tmp' || nm === 'genero_tmp' || /_tmp$/.test(nm)) {
          persist();
        }
      });

      // Guardar también al navegar entre pasos
      document.getElementById('btnNext')?.addEventListener('click', persist);
      document.getElementById('btnPrev')?.addEventListener('click', persist);

      // Guardar si el usuario se va
      window.addEventListener('beforeunload', persist);

      // Guardar explícitamente al pulsar "Editar perfil"
      document.querySelector('a[href^="/perfil"]')?.addEventListener('click', ()=>{ persist(); });

      // Limpiar memoria al enviar el formulario definitivo
      form.addEventListener('submit', clearMem);

      // utilidades en consola
      window._bdi2Progress = { persist, restore, clearMem };
    })();
  </script>
</body>
</html>
