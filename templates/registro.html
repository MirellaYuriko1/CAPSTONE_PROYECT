<!-- templates/registro.html -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crea tu cuenta</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg1:#e0f2ff; --bg2:#90caf9;
      --card-bg:#ffffff; --ink:#1f2937; --muted:#6b7280;
      --primary:#1e88e5; --primary-hover:#1565c0;
      --line:#e9eef6; --radius:28px; --radius-sm:12px;
      --shadow:0 14px 40px rgba(2,21,46,.10);
      --focus:0 0 0 3px rgba(30,136,229,.28);
      --ok:#22c55e; --err:#ef4444;
    }

    html,body{height:100%}
    body{
      margin:0; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
      background:linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 100%);
    }

    .login-wrap{min-height:100%; display:grid; place-items:center; padding:40px 16px;}
    .login-card{
      width:100%; max-width:620px; background:var(--card-bg); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:clamp(24px,4vw,48px); border:1px solid var(--line);
    }
    .login-title{
      font-family:'Merriweather', serif; font-weight:700; text-align:center; font-size:24px; margin-bottom:24px;
    }

    label{font-weight:600; color:#111827;}
    .form-control{
      height:48px; border-radius:var(--radius-sm); border:1px solid #e5e7eb;
      transition:border-color .2s ease, box-shadow .2s ease, background-position .2s ease;
      background-repeat:no-repeat; background-position: right 12px center; background-size:18px;
    }
    .form-control:focus{border-color:var(--primary); box-shadow:var(--focus);}

    .form-control.is-valid{
      border-color:var(--ok); box-shadow:0 0 0 3px rgba(34,197,94,.18);
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%2322c55e" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>');
    }
    .form-control.is-invalid{
      border-color:var(--err); box-shadow:0 0 0 3px rgba(239,68,68,.18);
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%23ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><circle cx="12" cy="16" r="1.2"/></svg>');
    }

    .pw-toggle{
      border:1px solid #e5e7eb; border-left:none; background:#fff;
      border-radius:0 var(--radius-sm) var(--radius-sm) 0; padding:0 14px;
    }

    .btn-primary{
      background:var(--primary); border-color:var(--primary); height:52px; font-weight:600; border-radius:999px;
      transition:background-color .2s ease, border-color .2s ease, box-shadow .25s ease, transform .1s ease;
    }
    .btn-primary:hover{ background:var(--primary-hover); border-color:var(--primary-hover); box-shadow:0 10px 22px rgba(21,101,192,.25); }
    .btn-primary:active{ transform:translateY(1px); }
    .btn-primary:disabled{ background:#bcd7f6; border-color:#bcd7f6; cursor:not-allowed; box-shadow:none; }

    .login-footer{ text-align:center; color:var(--muted); margin-top:16px; }
    .login-footer a{ color:var(--primary); text-decoration:none; font-weight:600; }
    .login-footer a:hover{ color:var(--primary-hover); text-decoration:underline; }

    .field-error{ font-size:12px; color:var(--err); margin-top:6px; display:none; }
    .field-error.show{ display:block; }
  </style>
</head>
<body>

  <main class="login-wrap">
    <section class="login-card">
      <h1 class="login-title">Crea tu cuenta</h1>

      {% if error %}
      <div class="alert alert-danger" role="alert">
        {{ error }}
      </div>
      {% endif %}

      <form id="registerForm" method="post" action="/registro" novalidate>
        <!-- Nombre de usuario -->
        <div class="mb-3">
          <label for="username" class="form-label">Nombre de usuario</label>
          <input id="username" name="username" type="text" class="form-control" placeholder="Ej: juan_23" required />
          <div id="usernameError" class="field-error" aria-live="polite"></div>
          <div class="form-text">3–20 caracteres, letras/números/guion bajo.</div>
        </div>

        <!-- Contraseña -->
        <div class="mb-3">
          <label for="password" class="form-label">Contraseña</label>
          <div class="input-group">
            <input id="password" name="password" type="password" class="form-control" placeholder="Contraseña" required />
            <button type="button" class="pw-toggle" aria-label="Mostrar/Ocultar contraseña"
                    onclick="togglePw('password','eye1')">
              <svg id="eye1" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                   viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
            </button>
          </div>
          <div class="form-text">Mínimo 6 caracteres.</div>
        </div>

        <!-- Confirmar contraseña -->
        <div class="mb-2">
          <label for="confirm_password" class="form-label">Confirmar contraseña</label>
          <div class="input-group">
            <input id="confirm_password" name="confirm_password" type="password" class="form-control" placeholder="Repite la contraseña" required />
            <button type="button" class="pw-toggle" aria-label="Mostrar/Ocultar contraseña"
                    onclick="togglePw('confirm_password','eye2')">
              <svg id="eye2" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                   viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
            </button>
          </div>
          <div id="confirmError" class="field-error" aria-live="polite"></div>
        </div>

        <!-- Botón -->
        <div class="d-grid mt-4">
          <button id="submitBtn" class="btn btn-primary" type="submit" disabled>Registrarme</button>
        </div>

        <p class="login-footer">
          ¿Ya tienes una cuenta? <a href="/form_login">Inicia sesión</a>
        </p>
      </form>
    </section>
  </main>

  <!-- Modal de registro exitoso -->
  <div class="modal fade" id="okModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius:16px">
        <div class="modal-body text-center p-4">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="#22c55e" stroke-width="2"></circle>
            <path d="M8 12l2.5 2.5L16 9" stroke="#22c55e" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          <h5 class="mt-3 mb-1">¡Registro exitoso!</h5>
          <p class="text-muted mb-4">Tu cuenta se creó correctamente.</p>
          <button id="goLogin" class="btn btn-primary px-4">Aceptar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (para el modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function togglePw(inputId, eyeId){
      const input = document.getElementById(inputId);
      const eye = document.getElementById(eyeId);
      const isHidden = input.type === 'password';
      input.type = isHidden ? 'text' : 'password';
      if (eye) eye.setAttribute('stroke', isHidden ? '#111' : 'currentColor');
    }

    (function(){
      const form = document.getElementById('registerForm');
      const username = document.getElementById('username');
      const password = document.getElementById('password');
      const confirm = document.getElementById('confirm_password');
      const submitBtn = document.getElementById('submitBtn');

      const usernameError = document.getElementById('usernameError');
      const confirmError = document.getElementById('confirmError');

      const userRegex = /^[A-Za-z0-9_]{3,20}$/;

      function validateUsername(){
        const value = username.value.trim();
        let ok = userRegex.test(value);
        username.classList.toggle('is-valid', ok);
        username.classList.toggle('is-invalid', !ok && value.length>0);
        usernameError.textContent = ok || value.length===0 ? "" : "Usa 3–20 caracteres: letras, números o _.";
        usernameError.classList.toggle('show', !ok && value.length>0);
        return ok;
      }

      function validatePassword(){
        const ok = password.value.length >= 6;
        password.classList.toggle('is-valid', ok);
        password.classList.toggle('is-invalid', !ok && password.value.length>0);
        return ok;
      }

      function validateConfirm(){
        const filled = confirm.value.length > 0;
        const same = confirm.value === password.value && password.value.length >= 6;
        confirm.classList.toggle('is-valid', same);
        confirm.classList.toggle('is-invalid', filled && !same);
        confirmError.textContent = (filled && !same) ? "Las contraseñas no coinciden." : "";
        confirmError.classList.toggle('show', filled && !same);
        return same;
      }

      function updateSubmit(){
        submitBtn.disabled = !(validateUsername() && validatePassword() && validateConfirm());
      }

      ['input','change'].forEach(evt=>{
        username.addEventListener(evt, updateSubmit);
        password.addEventListener(evt, updateSubmit);
        confirm.addEventListener(evt, updateSubmit);
      });

      form.addEventListener('submit', (e)=>{
        if(!(validateUsername() && validatePassword() && validateConfirm())){
          e.preventDefault();
        }
      });

      updateSubmit();
    })();
  </script>

  {% if exito %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const modal = new bootstrap.Modal(document.getElementById('okModal'));
      modal.show();
      document.getElementById('goLogin').addEventListener('click', () => {
        window.location.href = '/form_login';
      });
    });
  </script>
  {% endif %}

</body>
</html>
