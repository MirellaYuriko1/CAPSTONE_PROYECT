<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crea tu cuenta</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg1:#e0f2ff; --bg2:#90caf9;
      --card-bg:#ffffff; --ink:#1f2937; --muted:#6b7280;
      --primary:#1e88e5; --primary-hover:#1565c0;
      --line:#e9eef6; --radius:28px; --radius-sm:12px;
      --shadow:0 14px 40px rgba(2,21,46,.10);
      --focus:0 0 0 3px rgba(30,136,229,.28);
      --ok:#22c55e; --err:#ef4444;
    }
    html, body { min-height: 100%; }
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; 
      color:var(--ink);
      min-height: 100vh;
      background:linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 100%);
      background-repeat:no-repeat;
    }
    .login-wrap{ height:100%; display:grid; place-items:center; padding:40px 16px; }
    .login-card{
      width:100%; max-width:620px; background:var(--card-bg); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:clamp(24px,4vw,48px); border:1px solid var(--line);
    }
    .login-title{
      font-family:'Merriweather', serif; font-weight:700; text-align:center; font-size:24px; margin-bottom:24px;
    }
    label{font-weight:600; color:#111827;}
    /* ⬇️ Igualamos estilos para inputs y selects */
    .form-control, .form-select{
      height:48px; border-radius:var(--radius-sm); border:1px solid #e5e7eb;
      transition:border-color .2s ease, box-shadow .2s ease, background-position .2s ease;
      background-repeat:no-repeat; background-position: right 12px center; background-size:18px;
    }
    .form-control:focus, .form-select:focus{border-color:var(--primary); box-shadow:var(--focus);}
    .form-control.is-valid, .form-select.is-valid{
      border-color:var(--ok); box-shadow:0 0 0 3px rgba(34,197,94,.18);
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%2322c55e" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>');
    }
    .form-control.is-invalid, .form-select.is-invalid{
      border-color:var(--err); box-shadow:0 0 0 3px rgba(239,68,68,.18);
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%23ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><circle cx="12" cy="16" r="1.2"/></svg>');
    }
    .pw-toggle{
      border:1px solid #e5e7eb; border-left:none; background:#fff;
      border-radius:0 var(--radius-sm) var(--radius-sm) 0; padding:0 14px;
    }
    .btn-primary{
      background:var(--primary); border-color:var(--primary); height:52px; font-weight:600; border-radius:999px;
      transition:background-color .2s ease, border-color .2s ease, box-shadow .25s ease, transform .1s ease;
    }
    .btn-primary:hover{ background:var(--primary-hover); border-color:var(--primary-hover); box-shadow:0 10px 22px rgba(21,101,192,.25); }
    .btn-primary:active{ transform:translateY(1px); }
    .btn-primary:disabled{ background:#bcd7f6; border-color:#bcd7f6; cursor:not-allowed; box-shadow:none; }
    .login-footer{ text-align:center; color:var(--muted); margin-top:16px; }
    .login-footer a{ color:var(--primary); text-decoration:none; font-weight:600; }
    .login-footer a:hover{ color:var(--primary-hover); text-decoration:underline; }
    .field-error{ font-size:12px; color:var(--err); margin-top:6px; display:none; }
    .field-error.show{ display:block; }
  </style>
</head>
<body>

  <main class="login-wrap">
    <section class="login-card">
      <h1 class="login-title" id="pageTitle">Crea tu cuenta</h1>

      <!-- Alert para errores por querystring ?error=... -->
      <div id="alertError" class="alert alert-danger d-none" role="alert"></div>

      <form id="registerForm" method="post" action="/registro" novalidate data-mode="crear">
        <!-- Nombre + Apellido -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="nombre" class="form-label">Nombre</label>
            <input id="nombre" name="nombre" type="text" class="form-control"
                   placeholder="Tu nombre" required maxlength="50" />
            <div id="nombreError" class="field-error" aria-live="polite"></div>
          </div>
          <div class="col-md-6">
            <label for="apellido" class="form-label">Apellido</label>
            <input id="apellido" name="apellido" type="text" class="form-control"
                   placeholder="Tu apellido" required maxlength="50" />
            <div id="apellidoError" class="field-error" aria-live="polite"></div>
          </div>
        </div>

        <!-- Grado + Edad -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="grado" class="form-label">Grado</label>
            <input id="grado" name="grado" type="text" class="form-control"
                   placeholder="" required maxlength="15" />
            <div id="gradoError" class="field-error" aria-live="polite"></div>
          </div>
          <div class="col-md-6">
            <label for="edad" class="form-label">Edad</label>
            <input id="edad" name="edad" type="text" inputmode="numeric" class="form-control"
                   placeholder="" required maxlength="3" />
            <div id="edadError" class="field-error" aria-live="polite"></div>
          </div>
        </div>

        <!-- ⬇️ Nuevo: Género -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="genero" class="form-label">Género</label>
            <select id="genero" name="genero" class="form-select" required>
              <option value="" selected disabled>Selecciona...</option>
              <option value="Femenino">Femenino</option>
              <option value="Masculino">Masculino</option>
            </select>
            <div id="generoError" class="field-error" aria-live="polite"></div>
          </div>
        </div>

        <!-- Contraseña -->
        <div class="mb-3">
          <label for="password" class="form-label">
            Contraseña <small id="pwHint" class="text-muted"></small>
          </label>
          <div class="input-group">
            <input id="password" name="password" type="password" class="form-control" placeholder="Contraseña" />
            <button type="button" class="pw-toggle" aria-label="Mostrar/Ocultar contraseña" onclick="togglePw()">
              <svg id="eye" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
            </button>
          </div>
          <div id="passwordError" class="field-error" aria-live="polite"></div>
        </div>

        <!-- Confirmar contraseña -->
        <div class="mb-2">
          <label for="confirm_password" class="form-label">
            Confirmar contraseña <small id="cpwHint" class="text-muted"></small>
          </label>
          <div class="input-group">
            <input id="confirm_password" name="confirm_password" type="password"
                   class="form-control" placeholder="Repite la contraseña" />
            <button type="button" class="pw-toggle" aria-label="Mostrar/Ocultar contraseña" onclick="toggleConfirmPw()">
              <svg id="eye2" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                   viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
            </button>
          </div>
          <div id="confirmError" class="field-error" aria-live="polite"></div>
        </div>

        <!-- Botón -->
        <div class="d-grid mt-5">
          <button id="submitBtn" class="btn btn-primary" type="submit">Registrarme</button>
        </div>

        <p id="loginFooter" class="login-footer">
          ¿Ya tienes una cuenta? <a href="/form_login">Inicia sesión</a>
        </p>
      </form>
    </section>
  </main>

  <!-- Modal de registro exitoso -->
  <div class="modal fade" id="okModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius:16px">
        <div class="modal-body text-center p-4">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="#22c55e" stroke-width="2"></circle>
            <path d="M8 12l2.5 2.5L16 9" stroke="#22c55e" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          <h5 class="mt-3 mb-1">¡Registro exitoso!</h5>
          <p class="text-muted mb-4">Tu cuenta se creó correctamente.</p>
          <button id="goLogin" class="btn btn-primary px-4">Aceptar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function togglePw(){
      const input = document.getElementById('password');
      const eye = document.getElementById('eye');
      const isHidden = input.type === 'password';
      input.type = isHidden ? 'text' : 'password';
      eye.setAttribute('stroke', isHidden ? '#111' : 'currentColor');
    }
    function toggleConfirmPw(){
      const input = document.getElementById('confirm_password');
      const eye = document.getElementById('eye2');
      const isHidden = input.type === 'password';
      input.type = isHidden ? 'text' : 'password';
      eye.setAttribute('stroke', isHidden ? '#111' : 'currentColor');
    }

    (function(){
      const params = new URLSearchParams(location.search);
      const mode   = (params.get('mode') || 'crear').toLowerCase();
      const uid    = params.get('uid') || '';
      const nombreQS   = params.get('nombre') || '';
      const apellidoQS = params.get('apellido') || '';
      const exito  = params.get('exito') === '1';
      const error  = params.get('error');

      const form = document.getElementById('registerForm');
      const title = document.getElementById('pageTitle');
      const loginFooter = document.getElementById('loginFooter');
      const alertError = document.getElementById('alertError');
      const submitBtn = document.getElementById('submitBtn');

      const nombre = document.getElementById('nombre');
      const apellido = document.getElementById('apellido');
      const grado = document.getElementById('grado');
      const edad = document.getElementById('edad');
      const genero = document.getElementById('genero');      // ⬅️ nuevo
      const password = document.getElementById('password');
      const confirm  = document.getElementById('confirm_password');
      const pwHint = document.getElementById('pwHint');
      const cpwHint = document.getElementById('cpwHint');

      // Flags UX
      let formSubmitted = false;
      let touchedPassword = false;

      // Setup por modo
      form.dataset.mode = mode;
      if (mode === 'editar') {
        document.title = 'Editar perfil';
        title.textContent = 'Editar perfil';
        submitBtn.textContent = 'Guardar cambios';
        loginFooter.classList.add('d-none');
        form.action = '/perfil';

        if (uid) {
          const hid = document.createElement('input');
          hid.type = 'hidden';
          hid.name = 'uid';
          hid.value = uid;
          form.appendChild(hid);
        }

        nombre.value = nombreQS;
        apellido.value = apellidoQS;

        pwHint.textContent = '(opcional)';
        cpwHint.textContent = '(solo si cambias)';
      } else {
        document.title = 'Crea tu cuenta';
        title.textContent = 'Crea tu cuenta';
        submitBtn.textContent = 'Registrarme';
        form.action = '/registro';
        pwHint.textContent = '';
        cpwHint.textContent = '';
      }

      if (error) {
        alertError.textContent = error;
        alertError.classList.remove('d-none');
      }

      if (exito && mode === 'crear') {
        const modal = new bootstrap.Modal(document.getElementById('okModal'));
        modal.show();
        document.getElementById('goLogin').addEventListener('click', () => {
          window.location.href = '/form_login';
        });
      }

      // Validaciones
      const nombreError = document.getElementById('nombreError');
      const apellidoError = document.getElementById('apellidoError');
      const gradoError = document.getElementById('gradoError');
      const edadError = document.getElementById('edadError');
      const generoError = document.getElementById('generoError');   // ⬅️ nuevo
      const passwordError = document.getElementById('passwordError');
      const confirmError = document.getElementById('confirmError');

      function validateNombre(){
        const valor = nombre.value;
        if (valor.length === 0){
          nombre.classList.remove('is-valid','is-invalid');
          nombreError.textContent = "";
          nombreError.classList.remove('show');
          return false;
        }
        let msg = "";
        if (/^\s/.test(valor)){
          msg = "No debe iniciar con espacio.";
        } else if (valor.trim().length > 50){
          msg = "Máximo 50 caracteres.";
        } else if (/[^A-Za-zÁÉÍÓÚáéíóúÑñ ]/.test(valor)){
          msg = "Solo se permiten letras y espacios (sin números).";
        }
        const ok = msg === "";
        nombre.classList.toggle('is-valid', ok);
        nombre.classList.toggle('is-invalid', !ok);
        if (!ok){ nombreError.textContent = msg; nombreError.classList.add('show'); }
        else { nombreError.textContent = ""; nombreError.classList.remove('show'); }
        return ok;
      }

      function validateApellido(){
        const valor = apellido.value;
        if (valor.length === 0){
          apellido.classList.remove('is-valid','is-invalid');
          apellidoError.textContent = "";
          apellidoError.classList.remove('show');
          return false;
        }
        let msg = "";
        if (/^\s/.test(valor)){
          msg = "No debe iniciar con espacio.";
        } else if (valor.trim().length > 50){
          msg = "Máximo 50 caracteres.";
        } else if (/[^A-Za-zÁÉÍÓÚáéíóúÑñ ]/.test(valor)){
          msg = "Solo se permiten letras y espacios (sin números).";
        }
        const ok = msg === "";
        apellido.classList.toggle('is-valid', ok);
        apellido.classList.toggle('is-invalid', !ok);
        if (!ok){ apellidoError.textContent = msg; apellidoError.classList.add('show'); }
        else { apellidoError.textContent = ""; apellidoError.classList.remove('show'); }
        return ok;
      }

      function validateGrado(){
        const valor = grado.value;
        if (valor.length === 0){
          grado.classList.remove('is-valid','is-invalid');
          gradoError.textContent = "";
          gradoError.classList.remove('show');
          return false;
        }
        let msg = "";
        if (/^\s/.test(valor)){
          msg = "No debe iniciar con espacio.";
        } else if (valor.trim().length > 15){
          msg = "Máximo 15 caracteres.";
        }
        const ok = msg === "";
        grado.classList.toggle('is-valid', ok);
        grado.classList.toggle('is-invalid', !ok);
        if (!ok){ gradoError.textContent = msg; gradoError.classList.add('show'); }
        else { gradoError.textContent = ""; gradoError.classList.remove('show'); }
        return ok;
      }

      // Edad: solo números y rango 3–20
      function validateEdad() {
        const valor = edad.value.trim();
        if (valor.length === 0) {
          edad.classList.remove('is-valid', 'is-invalid');
          edadError.textContent = "";
          edadError.classList.remove('show');
          return false;
        }
        let msg = "";
        if (/^\s/.test(valor)) {
          msg = "No debe iniciar con espacio.";
        } else if (!/^\d+$/.test(valor)) {
          msg = "Solo se permiten números.";
        } else {
          const num = parseInt(valor, 10);
          if (num < 3) msg = "La edad mínima permitida es 3 años.";
          else if (num > 20) msg = "La edad máxima permitida es 20 años.";
        }
        const ok = msg === "";
        edad.classList.toggle('is-valid', ok);
        edad.classList.toggle('is-invalid', !ok);
        if (!ok) { edadError.textContent = msg; edadError.classList.add('show'); }
        else { edadError.textContent = ""; edadError.classList.remove('show'); }
        return ok;
      }

      // Género: requerido (Femenino/Masculino)
      function validateGenero(){
        const val = genero.value;
        const ok = !!val;
        genero.classList.toggle('is-valid', ok);
        genero.classList.toggle('is-invalid', !ok);
        generoError.textContent = ok ? "" : "Selecciona una opción.";
        generoError.classList.toggle('show', !ok);
        return ok;
      }

      // Password: no mostrar error hasta que se toque o envíe
      function validatePassword(){
        if (!touchedPassword && !formSubmitted) {
          password.classList.remove('is-valid','is-invalid');
          passwordError.textContent = "";
          passwordError.classList.remove('show');
          return false;
        }
        const val = password.value;
        let msg = "";
        if (form.dataset.mode === 'crear'){
          if (val.length === 0){
            msg = "Este campo es obligatorio.";
          } else if (val.length < 3 || val.length > 6){
            msg = "La contraseña debe tener entre 3 y 6 caracteres.";
          }
        } else {
          if (val.length > 0 && (val.length < 3 || val.length > 6)){
            msg = "La contraseña debe tener entre 3 y 6 caracteres.";
          }
        }
        const ok = msg === "";
        password.classList.toggle('is-valid', ok && val.length>0);
        password.classList.toggle('is-invalid', !ok);
        passwordError.textContent = msg;
        passwordError.classList.toggle('show', !ok);
        if (confirm.value.length > 0) { validateConfirm(); }
        return ok;
      }

      function validateConfirm(){
        const pv = password.value;
        const cv = confirm.value;
        if (form.dataset.mode === 'crear'){
          const same = pv.length>0 && cv.length>0 && pv === cv;
          confirm.classList.toggle('is-valid', same);
          confirm.classList.toggle('is-invalid', !same);
          confirmError.textContent = same ? "" : "Las contraseñas no coinciden.";
          confirmError.classList.toggle('show', !same);
          return same;
        } else {
          if (pv.length === 0 && cv.length === 0){
            confirm.classList.remove('is-valid','is-invalid');
            confirmError.textContent = "";
            confirmError.classList.remove('show');
            return true;
          }
          const same = pv.length>0 && cv.length>0 && pv === cv;
          confirm.classList.toggle('is-valid', same);
          confirm.classList.toggle('is-invalid', !same);
          confirmError.textContent = same ? "" : "Las contraseñas no coinciden.";
          confirmError.classList.toggle('show', !same);
          return same;
        }
      }

      function updateSubmit(){
        const okBase = validateNombre() && validateApellido() && validateGrado() && validateEdad() && validateGenero();
        const okPass = validatePassword() && validateConfirm();
        submitBtn.disabled = !(okBase && okPass);
      }

      // Listeners
      nombre.addEventListener('input', updateSubmit);
      apellido.addEventListener('input', updateSubmit);
      grado.addEventListener('input', updateSubmit);
      edad.addEventListener('input', updateSubmit);
      genero.addEventListener('change', updateSubmit);   // ⬅️ nuevo

      password.addEventListener('input', () => {
        touchedPassword = true;
        updateSubmit();
      });
      confirm.addEventListener('input', updateSubmit);

      form.addEventListener('submit', (e)=>{
        formSubmitted = true;
        if(!(validateNombre() && validateApellido() && validateGrado() && validateEdad() && validateGenero() && validatePassword() && validateConfirm())){
          e.preventDefault();
        }
      });

      updateSubmit();
    })();
  </script>
</body>
</html>
