<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="pageTitle">Crea tu cuenta</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <style>
    :root{ --bg1:#e0f2ff; --bg2:#90caf9; --card-bg:#ffffff; --ink:#1f2937; --muted:#6b7280;
           --primary:#1e88e5; --primary-hover:#1565c0; --line:#e9eef6; --radius:28px; --radius-sm:12px;
           --shadow:0 14px 40px rgba(2,21,46,.10); --focus:0 0 0 3px rgba(30,136,229,.28);
           --ok:#22c55e; --err:#ef4444; }
    html, body { height: 100%; margin: 0; }
    body{ font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
          background:linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 100%); background-repeat:no-repeat; }
    .wrap{ height:100%; display:grid; place-items:center; padding:40px 16px; }
    .card{ width:100%; max-width:620px; background:var(--card-bg); border-radius:var(--radius);
           box-shadow:var(--shadow); padding:clamp(24px,4vw,48px); border:1px solid var(--line); }
    .title{ font-family:'Merriweather', serif; font-weight:700; text-align:center; font-size:24px; margin-bottom:24px; }
    label{font-weight:600; color:#111827;}
    .form-control{ height:48px; border-radius:var(--radius-sm); border:1px solid #e5e7eb;
                   transition:border-color .2s, box-shadow .2s, background-position .2s;
                   background-repeat:no-repeat; background-position:right 12px center; background-size:18px; }
    .form-control:focus{border-color:var(--primary); box-shadow:var(--focus);}
    .form-control.is-valid{ border-color:var(--ok); box-shadow:0 0 0 3px rgba(34,197,94,.18);
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%2322c55e" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>'); }
    .form-control.is-invalid{ border-color:var(--err); box-shadow:0 0 0 3px rgba(239,68,68,.18);
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%23ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><circle cx="12" cy="16" r="1.2"/></svg>'); }
    .pw-toggle{ border:1px solid #e5e7eb; border-left:none; background:#fff; border-radius:0 var(--radius-sm) var(--radius-sm) 0; padding:0 14px; }
    .btn-primary{ background:var(--primary); border-color:var(--primary); height:52px; font-weight:600; border-radius:999px;
                  transition:background-color .2s, border-color .2s, box-shadow .25s, transform .1s; }
    .btn-primary:hover{ background:var(--primary-hover); border-color:var(--primary-hover); box-shadow:0 10px 22px rgba(21,101,192,.25); }
    .btn-primary:active{ transform:translateY(1px); }
    .btn-primary:disabled{ background:#bcd7f6; border-color:#bcd7f6; cursor:not-allowed; box-shadow:none; }
    .footer{ text-align:center; color:var(--muted); margin-top:16px; }
    .footer a{ color:var(--primary); text-decoration:none; font-weight:600; }
    .footer a:hover{ color:var(--primary-hover); text-decoration:underline; }
    .field-error{ font-size:12px; color:var(--err); margin-top:6px; display:none; }
    .field-error.show{ display:block; }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1 class="title" id="viewTitle">Crea tu cuenta</h1>

      <form id="userForm" method="post" action="/registro" novalidate>
        <!-- en edición, JS rellena este hidden con el uid -->
        <input type="hidden" id="uid" name="uid" />

        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="nombre" class="form-label">Nombre</label>
            <input id="nombre" name="nombre" type="text" class="form-control"
                   placeholder="Tu nombre" maxlength="50" required />
            <div id="nombreError" class="field-error" aria-live="polite"></div>
          </div>
          <div class="col-md-6">
            <label for="apellido" class="form-label">Apellido</label>
            <input id="apellido" name="apellido" type="text" class="form-control"
                   placeholder="Tu apellido" maxlength="50" required />
            <div id="apellidoError" class="field-error" aria-live="polite"></div>
          </div>
        </div>

        <div class="mb-3">
          <label for="password" class="form-label" id="pwLabel">Contraseña</label>
          <div class="input-group">
            <input id="password" name="password" type="password" class="form-control"
                   placeholder="Contraseña" />
            <button type="button" class="pw-toggle" aria-label="Mostrar/Ocultar contraseña" onclick="togglePw()">
              <svg id="eye" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
            </button>
          </div>
          <div id="passwordError" class="field-error" aria-live="polite"></div>
        </div>

        <div class="mb-2">
          <label for="password2" class="form-label" id="pw2Label">Confirmar contraseña</label>
          <div class="input-group">
            <input id="password2" name="password2" type="password" class="form-control"
                   placeholder="Repite la contraseña" />
            <button type="button" class="pw-toggle" aria-label="Mostrar/Ocultar contraseña" onclick="toggleConfirmPw()">
              <svg id="eye2" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
            </button>
          </div>
          <div id="confirmError" class="field-error" aria-live="polite"></div>
        </div>

        <div class="d-grid mt-5">
          <button id="submitBtn" class="btn btn-primary" type="submit" disabled>Registrarme</button>
        </div>

        <p class="footer" id="loginHint">
          ¿Ya tienes una cuenta? <a href="/form_login">Inicia sesión</a>
        </p>
      </form>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // -------- helpers ----------
    function qs(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    function togglePw(){
      const input = document.getElementById('password');
      const eye = document.getElementById('eye');
      const show = input.type === 'password';
      input.type = show ? 'text' : 'password';
      eye.setAttribute('stroke', show ? '#111' : 'currentColor');
    }
    function toggleConfirmPw(){
      const input = document.getElementById('password2');
      const eye = document.getElementById('eye2');
      const show = input.type === 'password';
      input.type = show ? 'text' : 'password';
      eye.setAttribute('stroke', show ? '#111' : 'currentColor');
    }

    // -------- validaciones ----------
    const nombre = document.getElementById('nombre');
    const apellido = document.getElementById('apellido');
    const password = document.getElementById('password');
    const password2 = document.getElementById('password2');
    const submitBtn = document.getElementById('submitBtn');

    const nombreError = document.getElementById('nombreError');
    const apellidoError = document.getElementById('apellidoError');
    const passwordError = document.getElementById('passwordError');
    const confirmError = document.getElementById('confirmError');

    function validateNombre(){
      const v = nombre.value;
      if (v.length === 0){ nombre.classList.remove('is-valid','is-invalid'); nombreError.textContent=""; nombreError.classList.remove('show'); return false; }
      let msg = "";
      if (/^\s/.test(v)) msg = "No debe iniciar con espacio.";
      else if (v.trim().length > 50) msg = "Máximo 50 caracteres.";
      else if (/[^A-Za-zÁÉÍÓÚáéíóúÑñ ]/.test(v)) msg = "Solo letras y espacios.";
      const ok = msg === "";
      nombre.classList.toggle('is-valid', ok); nombre.classList.toggle('is-invalid', !ok);
      nombreError.textContent = msg; nombreError.classList.toggle('show', !ok);
      return ok;
    }
    function validateApellido(){
      const v = apellido.value;
      if (v.length === 0){ apellido.classList.remove('is-valid','is-invalid'); apellidoError.textContent=""; apellidoError.classList.remove('show'); return false; }
      let msg = "";
      if (/^\s/.test(v)) msg = "No debe iniciar con espacio.";
      else if (v.trim().length > 50) msg = "Máximo 50 caracteres.";
      else if (/[^A-Za-zÁÉÍÓÚáéíóúÑñ ]/.test(v)) msg = "Solo letras y espacios.";
      const ok = msg === "";
      apellido.classList.toggle('is-valid', ok); apellido.classList.toggle('is-invalid', !ok);
      apellidoError.textContent = msg; apellidoError.classList.toggle('show', !ok);
      return ok;
    }

    // Para registro: PW obligatoria (3..6). Para edición: opcional (si se escribe, 3..6)
    function inRange(pw){ return pw.length >= 3 && pw.length <= 6; }
    function validatePassword(mode){
      const val = password.value;
      let ok = true, msg = "";
      if (mode === 'create'){
        if (!inRange(val)){ ok = false; msg = "La contraseña debe tener entre 3 y 6 caracteres."; }
      }else{
        if (val.length > 0 && !inRange(val)){ ok = false; msg = "Si la cambias, usa 3 a 6 caracteres."; }
      }
      password.classList.toggle('is-valid', ok && (val.length>0 || mode==='edit'));
      password.classList.toggle('is-invalid', !ok);
      passwordError.textContent = msg; passwordError.classList.toggle('show', !ok);
      return ok;
    }
    function validateConfirm(mode){
      let ok = true, msg = "";
      if (mode === 'create'){
        ok = password2.value === password.value && password.value.length>0;
        if (!ok) msg = "Las contraseñas no coinciden.";
      }else{
        if (password.value.length===0 && password2.value.length===0){ ok = true; }
        else{
          ok = password2.value === password.value && password.value.length>0;
          if (!ok) msg = "Las contraseñas no coinciden.";
        }
      }
      password2.classList.toggle('is-valid', ok && password2.value.length>0);
      password2.classList.toggle('is-invalid', !ok);
      confirmError.textContent = msg; confirmError.classList.toggle('show', !ok);
      return ok;
    }

    function hookValidation(mode){
      function update(){
        const baseOk = validateNombre() && validateApellido();
        const pwOk   = validatePassword(mode) && validateConfirm(mode);
        submitBtn.disabled = !(baseOk && pwOk);
      }
      nombre.addEventListener('input', update);
      apellido.addEventListener('input', update);
      password.addEventListener('input', ()=>{ validatePassword(mode); validateConfirm(mode); update(); });
      password2.addEventListener('input', ()=>{ validateConfirm(mode); update(); });
      update();
    }

    // -------- inicialización UI (sin Jinja) ----------
    (function init(){
      const mode = (qs('mode') || 'create').toLowerCase();   // 'create' | 'edit'
      const uid  = qs('uid');
      const form = document.getElementById('userForm');

      if (mode === 'edit'){
        // textos
        document.getElementById('pageTitle').textContent = 'Editar perfil';
        document.getElementById('viewTitle').textContent = 'Editar tu perfil';
        document.getElementById('pwLabel').textContent = 'Contraseña (opcional)';
        document.getElementById('pw2Label').textContent = 'Confirmar contraseña (opcional)';
        document.getElementById('loginHint').style.display = 'none';
        submitBtn.textContent = 'Guardar cambios';

        // action + uid
        form.action = '/perfil';
        document.getElementById('uid').value = uid || '';

        // traer datos para precargar
        if (uid){
          fetch('/api/usuario?uid=' + encodeURIComponent(uid))
            .then(r => r.ok ? r.json() : Promise.reject())
            .then(data => {
              if (data && data.ok){
                nombre.value = data.nombre || '';
                apellido.value = data.apellido || '';
              }
            })
            .catch(()=> {
              // si falla, seguimos, pero sin prefill
              console.warn('No se pudo precargar el usuario');
            });
        }
        hookValidation('edit');
      }else{
        // registro
        form.action = '/registro';
        document.getElementById('pageTitle').textContent = 'Crea tu cuenta';
        document.getElementById('viewTitle').textContent = 'Crea tu cuenta';
        password.placeholder = 'Contraseña';
        password2.placeholder = 'Repite la contraseña';
        submitBtn.textContent = 'Registrarme';
        hookValidation('create');
      }

      // validación on submit (defensiva)
      form.addEventListener('submit', (e)=>{
        const current = (qs('mode') || 'create').toLowerCase();
        const ok = (validateNombre() && validateApellido() &&
                   validatePassword(current === 'edit' ? 'edit' : 'create') &&
                   validateConfirm(current === 'edit' ? 'edit' : 'create'));
        if (!ok) e.preventDefault();
      });
    })();
  </script>
</body>
</html>
