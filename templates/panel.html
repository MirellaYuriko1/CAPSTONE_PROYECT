<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Panel de Administración</title>
  <style>
    :root{
      --bg:#f6f9fc; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --primary:#2563eb; --primary-2:#1e40af; --shadow:0 12px 28px rgba(2,8,23,.08);
      --ok:#16a34a; --mid:#d97706; --high:#dc2626;
      --radius:16px; --radius-sm:10px;
    }
    *{box-sizing:border-box}
    html,body{background:var(--bg);color:var(--ink);margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}

    /* Navbar */
    .nav{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 18px;background:#fff;border-bottom:1px solid var(--line);
      position:sticky;top:0;z-index:20
    }
    .brand{font-weight:800;letter-spacing:.2px}
    .user{position:relative}
    .user-btn{
      display:flex;align-items:center;gap:10px;
      background:#fff;border:1px solid var(--line);border-radius:999px;
      padding:8px 12px;cursor:pointer;box-shadow:0 2px 8px rgba(2,8,23,.04)
    }
    .user-avatar{
      width:28px;height:28px;display:inline-grid;place-items:center;border-radius:999px;
      background:#eef2ff;color:#3730a3;font-weight:700
    }
    .user-name{font-size:.95rem;color:#0b1220}
    .caret{font-size:12px;color:var(--muted)}
    .menu{
      position:absolute;right:0;top:48px;background:#fff;border:1px solid var(--line);
      border-radius:12px;box-shadow:var(--shadow);min-width:180px;display:none;overflow:hidden
    }
    .menu[data-open="true"]{display:block}
    .menu a{
      display:flex;align-items:center;gap:10px;padding:10px 12px;color:#0b1220;
      text-decoration:none;font-size:.95rem
    }
    .menu a:hover{background:#f8fafc}

    /* Layout */
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .header{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px
    }
    .title{font-size:1.15rem;margin:0}
    .pill{background:#eef2ff;color:#3730a3;border-radius:999px;padding:.25rem .6rem;font-size:.85rem}

    /* Actions */
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .search{
      display:flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--line);
      border-radius:999px;padding:6px 8px
    }
    .search input{
      border:none;outline:none;min-width:220px;font-size:.95rem
    }
    .btn{
      appearance:none;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer
    }
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-2)}
    .btn-ghost{
      background:#fff;border:1px solid var(--line);color:#0b1220
    }

    /* Table */
    .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:14px}
    table{width:100%;border-collapse:collapse;font-size:.95rem;background:#fff}
    th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left}
    th{font-weight:700;color:#0b1220;background:#f8fafc}
    tr:hover td{background:#f9fbff}
    .muted{color:var(--muted);font-size:.9rem}
    .lvl{font-weight:700;padding:.2rem .55rem;border-radius:999px;display:inline-block}
    .lvl.Bajo{background:#ecfdf5;color:#065f46}
    .lvl.Moderado{background:#fff7ed;color:#9a3412}
    .lvl.Alto,.lvl.Severo{background:#fef2f2;color:#991b1b}

    /* Responsive helpers */
    @media (max-width:640px){
      .search input{min-width:140px}
      .title{font-size:1rem}
    }
  </style>
</head>
<body>
  <header class="nav">
    <div class="brand">SCAS·Admin</div>

    <!-- Menú usuario -->
    <div class="user">
      <button class="user-btn" id="userBtn" aria-haspopup="true" aria-expanded="false">
        <span class="user-avatar">{{ (admin_nombre[:1] if admin_nombre else 'A') | upper }}</span>
        <span class="user-name">{{ admin_nombre }}</span>
        <span class="caret">▾</span>
      </button>
      <div class="menu" id="userMenu" role="menu" aria-label="Opciones de usuario" data-open="false">
        <a href="/logout" role="menuitem">↩️ Cerrar sesión</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="header">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <h2 class="title">Estudiantes · últimos resultados</h2>
          <span class="pill">{{ rows|length }} registros</span>
        </div>

        <div class="actions">
          <!-- Buscador -->
          <form class="search" action="/form_panel" method="GET">
            <input type="hidden" name="uid" value="{{ uid }}"/>
            <input type="text" name="q" placeholder="Buscar por nombre..." value="{{ q or '' }}" />
            <button class="btn btn-ghost" type="submit">Buscar</button>
          </form>

          <!-- Descargar Documento -->
          <form action="/descargar_documento" method="GET">
            <input type="hidden" name="uid" value="{{ uid }}"/>
            <input type="hidden" name="q" value="{{ q or '' }}"/>
            <button class="btn btn-primary" type="submit">Descargar Documento</button>
          </form>
        </div>
      </div>

      {% if rows and rows|length > 0 %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:70px;">ID</th>
              <th style="min-width:180px;">Nombre</th>
              <th>Género</th>
              <th>Edad</th>
              <th>Puntaje total</th>
              <th>Nivel</th>
              <th style="min-width:160px;">Fecha</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
            <tr>
              <td>{{ r.id_usuario }}</td>
              <td>{{ r.nombre }}</td>
              <td>{{ r.genero }}</td>
              <td>{{ r.edad }}</td>
              <td>{{ r.puntaje_total }}</td>
              <td><span class="lvl {{ r.nivel|default('') }}">{{ r.nivel }}</span></td>
              <td class="muted">{{ r.created_at }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="muted">No se encontraron resultados con el criterio actual.</p>
      {% endif %}
    </div>
  </main>

  <script>
    // Toggle del menú de usuario + cerrar al hacer clic fuera
    const btn = document.getElementById('userBtn');
    const menu = document.getElementById('userMenu');

    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = menu.getAttribute('data-open') === 'true';
      menu.setAttribute('data-open', !isOpen);
      btn.setAttribute('aria-expanded', String(!isOpen));
    });

    document.addEventListener('click', (e) => {
      if (!menu.contains(e.target) && !btn.contains(e.target)) {
        menu.setAttribute('data-open', 'false');
        btn.setAttribute('aria-expanded', 'false');
      }
    });

    // Submitear buscador al Enter
    document.querySelector('.search input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.target.closest('form').submit();
      }
    });
  </script>
</body>
</html>
