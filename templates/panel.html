<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Panel de Administración</title>
  <style>
    :root{
      --bg:#f6f9fc; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --primary:#2563eb; --primary-2:#1e40af; --shadow:0 12px 28px rgba(2,8,23,.08);
      --radius:16px; --radius-sm:10px;
    }
    *{box-sizing:border-box}
    html,body{background:var(--bg);color:var(--ink);margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}

    /* NAV */
    .nav{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:30}
    .brand{font-weight:800;letter-spacing:.2px}
    .user{position:relative}
    .user-btn{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid var(--line);border-radius:999px;padding:8px 12px;cursor:pointer;box-shadow:0 2px 8px rgba(2,8,23,.04)}
    .user-avatar{width:28px;height:28px;display:inline-grid;place-items:center;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:700}
    .user-name{font-size:.95rem}
    .caret{font-size:12px;color:var(--muted)}
    .menu{position:absolute;right:0;top:48px;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);min-width:180px;display:none;overflow:hidden}
    .menu[data-open="true"]{display:block}
    .menu a{display:flex;align-items:center;gap:10px;padding:10px 12px;color:#0b1220;text-decoration:none;font-size:.95rem}
    .menu a:hover{background:#f8fafc}

    /* LAYOUT */
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}

    /* TOP BAR (title + download) */
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px;flex-wrap:wrap}
    .title{font-size:1.1rem;margin:0}
    .pill{background:#eef2ff;color:#3730a3;border-radius:999px;padding:.25rem .6rem;font-size:.85rem}

    /* CONTROLS (buscar) */
    .controls{display:flex;align-items:center;justify-content:flex-end;gap:12px;flex-wrap:wrap;margin:10px 0}
    .search{display:flex;align-items:center;gap:8px}
    .search input{border:1px solid var(--line);border-radius:8px;padding:8px 10px;min-width:220px}
    .btn{appearance:none;border:none;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-2)}
    .btn-outline{background:#fff;border:1px solid var(--line);color:#0b1220}

    /* TABLE */
    .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:14px}
    table{width:100%;border-collapse:collapse;font-size:.95rem;background:#fff}
    th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left;white-space:nowrap}
    th{font-weight:700;color:#0b1220;background:#f8fafc}
    tr:hover td{background:#f9fbff}
    .muted{color:var(--muted);font-size:.9rem}
    .lvl{font-weight:700;padding:.2rem .55rem;border-radius:999px;display:inline-block}
    .lvl.Bajo{background:#ecfdf5;color:#065f46}
    .lvl.Moderado{background:#fff7ed;color:#9a3412}
    .lvl.Alto,.lvl.Severo{background:#fef2f2;color:#991b1b}

    /* FOOT (status + pagination) */
    .foot{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-top:10px}
    .pagination{display:flex;align-items:center;gap:6px}
    .page{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
    .page[aria-current="true"]{background:var(--primary);color:#fff;border-color:var(--primary)}
    .page:disabled{opacity:.5;cursor:not-allowed}

    @media (max-width:640px){
      .search input{min-width:140px}
      .title{font-size:1rem}
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <header class="nav">
    <div class="brand">SCAS·Admin</div>
    <div class="user">
      <button class="user-btn" id="userBtn" aria-haspopup="true" aria-expanded="false">
        <span class="user-avatar">{{ (admin_nombre[:1] if admin_nombre else 'A') | upper }}</span>
        <span class="user-name">Buen día, <strong>{{ admin_nombre }}</strong>
        <span class="caret">▾</span>
      </button>
      <div class="menu" id="userMenu" role="menu" aria-label="Opciones de usuario" data-open="false">
        <a href="/" role="menuitem">↩️ Cerrar sesión</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="top">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <h2 class="title">Estudiantes · últimos resultados</h2>
          <span class="pill">{{ rows|length }} registros</span>
        </div>
        
      </div>

      <!-- BUSCADOR (derecha, estilo DataTable) -->
      <div class="controls">
        <div class="search">
          <label for="globalSearch" class="muted">Buscar:</label>
          <input id="globalSearch" type="search" placeholder="Nombre, género, nivel..." />
        </div>
      </div>

      <!-- TABLA (sin columna Detalle) -->
      <div class="table-wrap">
        <table id="dataTable">
          <thead>
            <tr>
              <th style="min-width:60px;">#</th>
              <th style="min-width:200px;">Nombre</th>
              <th>Género</th>
              <th>Edad</th>
              <th>Puntaje</th>
              <th>Nivel</th>
              <th>ML</th>
              <th>Conf.</th>
              <th style="min-width:170px;">Fecha</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            {% for r in rows %}
            <tr>
              <td>{{ r.id_usuario }}</td>
              <td>{{ r.nombre }}</td>
              <td>{{ r.genero }}</td>
              <td>{{ r.edad }}</td>
              <td>{{ r.puntaje_total }}</td>
              <td><span class="lvl {{ r.nivel|default('') }}">{{ r.nivel }}</span></td>
              <td>
  {% if row.ml_label %}
    {% set ml = (row.ml_label or '')|lower %}
    <span class="badge rounded-pill
      {% if ml == 'muy alto' %} bg-danger
      {% elif ml == 'alto' %} bg-danger-subtle text-danger
      {% elif ml == 'elevado' %} bg-warning text-dark
      {% elif ml == 'normal' %} bg-success
      {% else %} bg-secondary
      {% endif %}">
      {{ row.ml_label }}
    </span>
  {% else %} — {% endif %}
</td>

<td>
  {% if row.ml_conf %}
    <span class="badge rounded-pill bg-secondary">
      {{ row.ml_conf }}{% if row.ml_conf_pct is not none %} ({{ '%.1f'|format(row.ml_conf_pct) }}%){% endif %}
    </span>
  {% else %} — {% endif %}
</td>

              <td class="muted">{{ r.created_at }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- FOOTER con paginación de 10 en 10 -->
      <div class="foot">
        <div class="muted" id="statusText">Mostrando 0 a 0 de 0 registros</div>
        <div class="pagination" id="pagination">
          <button class="page" id="prevBtn">Anterior</button>
          <div id="pageNums" style="display:flex;gap:6px;"></div>
          <button class="page" id="nextBtn">Siguiente</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ===== Menú usuario =====
    const userBtn = document.getElementById('userBtn');
    const userMenu = document.getElementById('userMenu');
    userBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = userMenu.getAttribute('data-open') === 'true';
      userMenu.setAttribute('data-open', !isOpen);
      userBtn.setAttribute('aria-expanded', String(!isOpen));
    });
    document.addEventListener('click', (e) => {
      if (!userMenu.contains(e.target) && !userBtn.contains(e.target)) {
        userMenu.setAttribute('data-open', 'false');
        userBtn.setAttribute('aria-expanded', 'false');
      }
    });

    // ===== DataTable-like (vanilla) =====
    const tbody = document.getElementById('tableBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const searchInput = document.getElementById('globalSearch');
    const statusText = document.getElementById('statusText');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageNums = document.getElementById('pageNums');
    const dlForm = document.getElementById('dlForm');
    const dlQuery = document.getElementById('dlQuery');

    let current = 1;
    const pageSize = 5; // <- fijo 10 por página
    let filtered = rows.slice(); // inicia con todo

    function render() {
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (current > totalPages) current = totalPages;
      const startIdx = (current - 1) * pageSize;
      const endIdx = Math.min(startIdx + pageSize, total);

      rows.forEach(r => r.style.display = 'none');
      filtered.slice(startIdx, endIdx).forEach(r => r.style.display = '');

      statusText.textContent = total
        ? `Mostrando registros del ${startIdx + 1} al ${endIdx} de un total de ${total} registros`
        : 'Mostrando 0 a 0 de 0 registros';

      prevBtn.disabled = current === 1;
      nextBtn.disabled = current === totalPages;

      pageNums.innerHTML = '';
      const maxPages = 6;
      let start = Math.max(1, current - 2);
      let end = Math.min(totalPages, start + maxPages - 1);
      if (end - start + 1 < maxPages) start = Math.max(1, end - maxPages + 1);

      for (let p = start; p <= end; p++) {
        const btn = document.createElement('button');
        btn.className = 'page';
        btn.textContent = p;
        btn.setAttribute('aria-current', String(p === current));
        btn.addEventListener('click', () => { current = p; render(); });
        pageNums.appendChild(btn);
      }
    }

    function applyFilter() {
      const q = searchInput.value.trim().toLowerCase();
      filtered = rows.filter(tr => tr.textContent.toLowerCase().includes(q));
      current = 1;
      render();
    }

    searchInput.addEventListener('input', applyFilter);
    prevBtn.addEventListener('click', () => { if (current > 1) { current--; render(); }});
    nextBtn.addEventListener('click', () => {
      const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      if (current < totalPages) { current++; render(); }
    });

    // sincroniza filtro con descarga (servidor filtra por nombre con LIKE)
    dlForm.addEventListener('submit', () => {
      dlQuery.value = searchInput.value.trim();
    });

    // inicial
    render();
  </script>
</body>
</html>
