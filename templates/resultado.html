<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Resultados BDI-II (Beck)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#e0f2ff; --bg2:#90caf9;
      --ink:#0f172a; --muted:#475569;
      --brand:#1e88e5; --brand-dark:#1565c0;
      --panel:#ffffff; --line:#e2e8f0; --radius:24px;
      --shadow:0 20px 60px rgba(2,21,46,.12);
    }
    html, body { min-height: 100%; }
    body{
      margin:0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
      min-height: 100vh;
      background: linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
      background-repeat:no-repeat;
    }
    .hero{ padding-block: clamp(48px, 8vw, 96px); }
    .hero-card{
      max-width: 980px; margin-inline: auto;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(4px);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: clamp(24px, 5vw, 56px);
    }
    h1{
      font-family: 'Merriweather', serif;
      font-weight: 700;
      text-align: center;
      color: var(--brand-dark);
      font-size: clamp(26px, 4vw, 40px);
      margin-bottom: 8px;
    }
    .subtitle{ text-align:center; color:var(--muted); margin-bottom: 18px; font-size:.95rem; }

    .user-summary{
      text-align:center; font-weight:700; color:#0f172a;
      font-size: clamp(16px,1.6vw,18px); margin-bottom: 6px;
    }

    .badge-level{ font-size:.9rem; border-radius:999px; padding:.4rem .7rem; font-weight:700; }
    .lvl-min { background:#e8f7ff; color:#075985; border:1px solid #bae6fd; }
    .lvl-lev { background:#fef9c3; color:#854d0e; border:1px solid #fde68a; }
    .lvl-mod { background:#ffedd5; color:#9a3412; border:1px solid #fdba74; }
    .lvl-sev { background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }

    .meter{
      border:1px solid var(--line); border-radius:16px; background:#eef2f7;
      height:16px; overflow:hidden;
    }
    .meter-bar{
      height:100%; width:0; background:linear-gradient(90deg,#7ee3ff,#22c3e6);
      transition: width .6s ease;
    }
    .score-line{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .score-chip{ font-weight:700; color:#334155; }

    .legend{ display:grid; gap:6px; font-size:.92rem; color:#475569; }
    .legend .row{ display:flex; justify-content:space-between; border-bottom:1px dashed #e5e7eb; padding:6px 0; }
    .legend .row span:first-child{ font-weight:600; color:#0f172a; }

    .ml-wrap{ display:flex; justify-content:center; margin-top:8px; }
    .ml-card{
      display:inline-flex; align-items:center; gap:8px; justify-content:center;
      border:1px dashed #c7d2fe; background:#f8fafc; border-radius:12px; padding:8px 12px;
    }
    .badge-ml{ background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; }
    .hint{ position:relative; display:inline-flex; align-items:center; justify-content:center;
           width:20px; height:20px; border-radius:50%; border:1px solid #cbd5e1; color:#475569;
           cursor:help; background:#fff; font-size:.8rem; line-height:1; }
    .hint .tip{ display:none; position:absolute; top:130%; left:50%; transform:translateX(-50%);
                min-width: 240px; background:#111827; color:#fff; padding:8px 10px;
                border-radius:8px; font-size:.75rem; z-index:10; box-shadow:0 10px 30px rgba(0,0,0,.15); }
    .hint:hover .tip, .hint:focus .tip{ display:block; }

    .actions{ margin-top: 18px; display:flex; gap:8px; justify-content:center; }
    .btn-outline-primary{
      background:#eef2f7; border-color:#eef2f7; color:#000; font-weight:600;
      padding:8px 20px; border-radius:999px;
    }
    .btn-outline-primary:hover{ background:#e2e8f0; border-color:#e2e8f0; color:#000; }
  </style>
</head>
<body>
  <main class="hero">
    <section class="hero-card">

      <h1>Resultados BDI-II (Beck)</h1>
      <p class="subtitle">Inventario de DepresiÃ³n de Beck, 21 Ã­tems (Ãºltimas 2 semanas)</p>

      {% if notfound %}
        <p class="user-summary">No se encontrÃ³ un cuestionario guardado para este usuario.</p>
        <div class="actions">
          <a href="/cuestionario?uid={{ uid }}" class="btn btn-outline-primary">Ir al cuestionario</a>
          <a href="/" class="btn btn-link">Inicio</a>
        </div>
      {% else %}

        <!-- Frase principal -->
        <p class="user-summary">
          <strong>{{ nombre }}</strong>, tu resultado global es:
        </p>

        {# Calcular nivel automÃ¡ticamente con los cortes BDI-II si no viene dado #}
        {% set _total = total or 0 %}
        {% set _nivel_auto = (
            'mÃ­nimo' if _total <= 13 else
            ('leve' if _total <= 19 else
              ('moderado' if _total <= 28 else 'severo'))
          )
        %}
        {% set nivel_mostrar = (nivel_total or _nivel_auto) | lower %}

        {# Clase visual segÃºn nivel #}
        {% set lvl_class = 'lvl-min' %}
        {% if nivel_mostrar in ['leve'] %}{% set lvl_class = 'lvl-lev' %}
        {% elif nivel_mostrar in ['moderado'] %}{% set lvl_class = 'lvl-mod' %}
        {% elif nivel_mostrar in ['severo','grave'] %}{% set lvl_class = 'lvl-sev' %}
        {% endif %}

        <div class="d-flex justify-content-center mb-2">
          <span class="badge badge-level {{ lvl_class }}">{{ nivel_mostrar|title }}</span>
        </div>

        <!-- Barra de total (0-63) -->
        {% set pct = (_total * 100 / 63) | round(0, 'floor') %}
        <div class="scas-item mb-3">
          <div class="score-line mb-2">
            <span class="scas-name">Puntaje total</span>
            <span class="score-chip">{{ _total }} / 63 pts.</span>
          </div>
          <div class="meter">
            <div class="meter-bar" data-pct="{{ pct }}"></div>
          </div>
        </div>

        <!-- Bloque ML opcional -->
        {% if pred_ml or conf_ml %}
          <div class="ml-wrap">
            <div class="ml-card" role="group" aria-label="Resultado del modelo de Machine Learning">
              <span class="badge badge-level badge-ml">ðŸ¤– Modelo (ML)</span>

              {% set nivel_chip = (pred_ml or nivel_mostrar) %}
              {% set nl = (nivel_chip or '')|lower %}
              {% set chip_cls = 'lvl-min' %}
              {% if nl == 'leve' %}{% set chip_cls = 'lvl-lev' %}
              {% elif nl == 'moderado' %}{% set chip_cls = 'lvl-mod' %}
              {% elif nl in ['severo','grave'] %}{% set chip_cls = 'lvl-sev' %}
              {% endif %}
              <span class="badge badge-level {{ chip_cls }}">{{ nivel_chip|title }}</span>

              {% if conf_ml %}
                <span class="badge {{ conf_class }}">
                  Confianza: {{ conf_ml }}{% if conf_pct is not none %} ({{ conf_pct|round(0,'floor') }}%){% endif %}
                </span>
              {% endif %}

              <span class="hint" tabindex="0" aria-label="PredicciÃ³n generada por un modelo con tus respuestas. No es diagnÃ³stico.">
                i
                <span class="tip">PredicciÃ³n generada por un modelo con tus respuestas. No es diagnÃ³stico.</span>
              </span>
            </div>
          </div>
          <p class="text-center text-muted mt-2" style="font-size:.85rem">Estimado por el modelo (no es un diagnÃ³stico).</p>
        {% endif %}

        <!-- Leyenda de cortes BDI-II -->
        <h3 class="scas-title mt-4">Â¿CÃ³mo interpretar el resultado?</h3>
        <div class="legend">
          <div class="row"><span>MÃ­nimo</span><span>0â€“13</span></div>
          <div class="row"><span>Leve</span><span>14â€“19</span></div>
          <div class="row"><span>Moderado</span><span>20â€“28</span></div>
          <div class="row"><span>Severo</span><span>29â€“63</span></div>
        </div>

        <div class="actions">
          <a href="/cuestionario?uid={{ uid }}" class="btn btn-outline-primary">Volver al cuestionario</a>
          <a href="/" class="btn btn-danger">Cerrar sesiÃ³n</a>
        </div>
      {% endif %}
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.meter-bar[data-pct]').forEach(el => {
        const pct = Number(el.dataset.pct || 0);
        requestAnimationFrame(() => { el.style.width = Math.max(0, Math.min(100, pct)) + '%'; });
      });
    });
  </script>
</body>
</html>